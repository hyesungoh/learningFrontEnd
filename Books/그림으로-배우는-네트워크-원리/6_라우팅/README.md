# 라우팅

## 외부 네트워크로 데이터를 보낸다

* 다른 네트워크에 데이터를 보내려면 네트워크를 서로 연결하는 라우터로 전송해야 함
  + 전송할 대상이 되는 데이터는 IP 패킷
  + TCP/IP 계층에서 인터넷층
  + IP 헤더의 목적지 IP 주소를 확인, TTL과 헤더 체크섬만 변경
    - NAT 주소 변환이 이루어질 때는 IP 주소도 변경됨
    - TTL? Time To Live
      + 패킷이 네트워크를 통과할 때마다 1씩 감소
      + 0이 되면 해당 패킷은 폐기
      + 무한 루프를 방지하기 위한 장치
    - 헤더 체크섬? 헤더의 오류를 검출하기 위한 값
      + 헤더의 값이 변경되면 체크섬도 변경
    - NAT? Network Address Translation
      + 사설 IP 주소를 공인 IP 주소로 변환하는 기술
      + 사설 IP 주소는 인터넷에서 사용할 수 없음
      + NAT 장비는 사설 IP 주소를 공인 IP 주소로 변환해 인터넷에 연결

* 이더넷 헤더 등 네트워크 인터페이스층 프로토콜의 헤더는 라우터가 전송할 때 완전히 새로운 헤더로 교체

## 라우터에서 네트워크 연결에 필요한 주소 설정

* 라우터로 네트워크끼리 서로 접속
* 네트워크를 접속하기 위해서는 라우터의 인터페이스에 IP 주소를 설정

## 데이터의 전송처를 결정한다

* 라우팅 테이블에 등록되어 있는 값을 기준으로 직접 접속(같은 네트워크)할지
* 넥스트 홉(다음 라우터)을 통해 전송할지 결정

## 다음 라우터로 데이터를 전송한다

* 다음 라우터에 데이터를 전송해야 한다면 ARP를 실행해 다음 라우터의 MAC 주소를 알아냄
* 이후 새로운 이더넷 헤더로 바꾼 후 IP 패킷을 전송함
  + 이때 이더넷 헤더는 완전히 새로운 것, FCS도 새로 추가됨
  + IP 주소는 변하지 않음
    - 다만 IP 헤더의 TTL을 -1하고
    - 헤더 체크섬을 다시 계산

## 최종 주소를 확인한다

* 라우팅 처리는 라우터마다 알아서 처리
* 최종 목적지에 직접 접속된 라우터까지 IP 패킷이 전송됨

## 최종 목적지로 데이터를 보낸다

* 마지막 라우터는 IP 패킷의 목적지 IP 주소의 MAC 주소를 ARP로 질의해 마침내 IP 패킷을 전송

## 라우터가 인식하는 네트워크 정보

* 라우팅 테이블에는 어떤 네트워크로 IP 패킷을 전송하려면, 다음에 어느 라우터로 전송해야 하는지 경로가 등록되어 있음
  + 자신을 중심으로 이웃 라우터만 저장
  + 라우팅 테이블 상에서 인식할 수 없는 곳으로 가는 IP 패킷은 모두 폐기

## 라우팅 테이블의 가장 기본적인 정보

* 라우팅 테이블에 경로 정보를 등록하는 방법은 3가지
  + 직접 접속
  + 스태틱 라우팅
  + 라우팅 프로토콜

* 인터페이스에 IP 주소를 설정하면 직접 접속된 경로 정보가 테이블에 등록됨

## 직접 접속되지 않은 경로 정보를 등록하는 방법

* 스태틱 라우팅
  + 네트워크 주소, 서브넷 마스크와 넥스트 홉 주소를 커맨드로 입력해 등록

* 라우팅 프로토콜
  + 라우터끼리 정보를 교환해 경로 정보를 등록
  + RIP, OSPF, BGP 등이 있음

## 방대한 경로 정보를 모아서 등록하는 방법

* 모든 네트워크의 경로 정보를 등록하는 건 어려움
  + 경로 요약을 통해 복수의 네트워크 주소를 하나로 모아 테이블에 등록할 수 있음

## 경로 정보를 최대한으로 줄이는 방법

* 디폴트 경로
  + 모든 네트워크를 집약한 것
  + 미지의 네트워크로 가는 패킷을 전송하기 위한 경로 정보로 흔히 설명하지만, 이는 올바르지 않음
  + 디폴트 경로는 모든 네트워크를 나타내니, 미지의 네트워크는 없는 것

## 라우터와 레이어2 스위치의 기능을 가진 데이터 전송 기기

* 레이어3 스위치
  + 레이어2 스위치에 라우터 기능을 추가한 네트워크 기기
  + 레이어2 스위치처럼 데이터 전송도 할 수 있고, 
  + 라우터처럼 데이터 전송도 할 수 있음

* 같은 네트워크에서는 레이어2 스위치처럼 MAC 주소를 기반으로 전송
  + 다른 네트워크에 전송할 때는 IP 주소를 기반으로 전송

## 레이어2 스위치로 네트워크를 분할한다

* 레이어2 스위치는 하나의 이더넷 네트워크를 구성하는 기기
  + 하나의 네트워크에 많은 기기를 연결하면 불필요한 데이터 전송이 많이 발생하게 됨
    - 브로드캐스트 스톰(이란게 있다네요)
  + 이를 위해 분리할 필요가 있음

* 레이어2 스위치에서 네트워크를 복수로 분할할 수 있게 하는 것이 VLAN
  + 일반 레이어2 스위치는 모든 포트 사이에서 프레임을 전송
  + VLAN으로 나누어 같은 VLAN에 할당한 포트끼리만 전송할 수 있도록 한 것

## VLAN을 사용하는 이유

* 보안 향상
  + 데이터가 전송되는 범위를 제한하기 때문에

## 복수의 접속선을 한 줄로 깔끔하게 정리한다

* VLAN은 1대뿐만 아니라 복수의 스위치에 걸쳐서 만들 수도 있음
  + 스위치 간의 연결이 VLAN 마다 필요
  + 스위치 사이를 효율적으로 연결하기 위해서 '태그 VLAN'(트렁크라고도 불림) 포트가 있음

* 태그 VLAN
  + 태그 VLAN 포트로 송수신하는 이더넷 프레임에는 VLAN 태그가 추가됨
  + TPID 2바이트
  + TCI 2바이트
    - PRIORITY 3비트
    - CFI 1비트
    - VLAN ID 12비트

## 기기 추가나 배선을 변경하기 않고 네트워크를 바꾼다

* VLAN과 관련 포트 설정에 따라, 기기 추가나 배선 변경 등을 하지 않고도 네트워크를 몇 개로 할지 자유롭게 결정할 수 있음
  + 즉 네트워크를 유연하게 구성할 수 있음

## 분할한 네트워크끼리 연결하는 방법

* VLAN을 서로 연결해서 VLAN끼리 통신할 수 있게 하는 것을 VLAN 간 라우팅이라고 함

* 이를 위해서는 라우터 또는 레이어3 스위치가 필요함
  + 레이어3 스위치가 효율적임

* 레이어3 스위치에 IP 주소를 설정해서 VLAN을 연결할 수 있음
  + 레이어3 스위치 내부의 가상 인터페이스에 IP 주소를 설정
  + 레이어3 스위치의 포트 자체에 IP 주소를 설정

## PC에도 라우팅 테이블이 있다

* PC나 서버등 TCP/IP를 이용하는 모든 기기에는 라우팅 테이블이 있고, 이에 따라 라우팅함

* PC도 라우팅 테이블에 IP 패킷을 전송하고 싶은 모든 네트워크를 등록해야 가능함
  + 모든 경로 정보를 등록하는건 불가능하고 의미도 없음
  
* PC는 자세히 경로 정보를 등록하지 않고 기본적으로 두 가지만 함
  + 직접 접속 경로 정보: IP 주소 설정
  + 디폴트 경로: 기본 게이트웨이의 IP 주소 설정

* 본인이 속해있는 네트워크가 아니면 전부 기본 게이트웨이로 보내버림
